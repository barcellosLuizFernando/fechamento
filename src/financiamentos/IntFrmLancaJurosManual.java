/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package financiamentos;

import conn.ConexaoMySQL;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author luiz.barcellos
 */
public class IntFrmLancaJurosManual extends javax.swing.JInternalFrame {

    private final ConexaoMySQL cn;
    private String idAnterior;
    private int var_consulta;
    private String sql;
    private double outstandingbalance;
    private boolean var_update;
    private String vencimento;
    private double oldInterest;

    /**
     * Creates new form IntFrmLancaJurosManual
     *
     * @param conn
     */
    public IntFrmLancaJurosManual(ConexaoMySQL conn) {
        initComponents();

        this.cn = conn;
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jTxtCompetence = new javax.swing.JFormattedTextField(tools.MascaraTextField.competenceBR());
        jLabel2 = new javax.swing.JLabel();
        jTxtIdBank = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();
        JtxtContractNumber = new javax.swing.JTextField();
        jLabel4 = new javax.swing.JLabel();
        jTxtInterest = new tools.JNumberFormatField99(tools.MascaraTextField.numeroBR());
        jTxtNameBank = new javax.swing.JTextField();
        jLabel5 = new javax.swing.JLabel();
        jTxtOutstandingBalance = new javax.swing.JTextField();
        jButton1 = new javax.swing.JButton();
        jLabel6 = new javax.swing.JLabel();
        jTxtOutstandingBalanceNew = new javax.swing.JTextField();
        jPanel2 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTable1 = new javax.swing.JTable();

        setClosable(true);
        setTitle("Lançamento manual de Juros");

        jLabel1.setText("Competência");

        jTxtCompetence.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        jTxtCompetence.setNextFocusableComponent(jTxtIdBank);
        jTxtCompetence.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                jTxtCompetenceFocusGained(evt);
            }
            public void focusLost(java.awt.event.FocusEvent evt) {
                jTxtCompetenceFocusLost(evt);
            }
        });
        jTxtCompetence.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jTxtCompetenceKeyPressed(evt);
            }
        });

        jLabel2.setText("Instituição");

        jTxtIdBank.setNextFocusableComponent(JtxtContractNumber);
        jTxtIdBank.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                jTxtIdBankFocusGained(evt);
            }
            public void focusLost(java.awt.event.FocusEvent evt) {
                jTxtIdBankFocusLost(evt);
            }
        });
        jTxtIdBank.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jTxtIdBankKeyPressed(evt);
            }
        });

        jLabel3.setText("Contrato");

        JtxtContractNumber.setNextFocusableComponent(jTxtInterest);
        JtxtContractNumber.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                JtxtContractNumberFocusGained(evt);
            }
            public void focusLost(java.awt.event.FocusEvent evt) {
                JtxtContractNumberFocusLost(evt);
            }
        });
        JtxtContractNumber.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                JtxtContractNumberKeyPressed(evt);
            }
        });

        jLabel4.setText("Juros");

        jTxtInterest.setNextFocusableComponent(jButton1);
        jTxtInterest.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                jTxtInterestFocusGained(evt);
            }
            public void focusLost(java.awt.event.FocusEvent evt) {
                jTxtInterestFocusLost(evt);
            }
        });
        jTxtInterest.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jTxtInterestKeyPressed(evt);
            }
        });

        jTxtNameBank.setEnabled(false);

        jLabel5.setText("Saldo");

        jTxtOutstandingBalance.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        jTxtOutstandingBalance.setEnabled(false);

        jButton1.setText("Gravar");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        jLabel6.setText("Atualizado");

        jTxtOutstandingBalanceNew.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        jTxtOutstandingBalanceNew.setEnabled(false);

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel1)
                    .addComponent(jLabel2)
                    .addComponent(jLabel3)
                    .addComponent(jLabel4))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jTxtCompetence, javax.swing.GroupLayout.PREFERRED_SIZE, 80, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jTxtIdBank, javax.swing.GroupLayout.PREFERRED_SIZE, 50, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jTxtNameBank, javax.swing.GroupLayout.PREFERRED_SIZE, 288, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                            .addComponent(jTxtInterest, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 85, Short.MAX_VALUE)
                            .addComponent(JtxtContractNumber, javax.swing.GroupLayout.Alignment.LEADING))
                        .addGap(18, 18, 18)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addComponent(jLabel5)
                                .addGap(34, 34, 34)
                                .addComponent(jTxtOutstandingBalance, javax.swing.GroupLayout.PREFERRED_SIZE, 111, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addComponent(jLabel6)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(jTxtOutstandingBalanceNew, javax.swing.GroupLayout.PREFERRED_SIZE, 111, javax.swing.GroupLayout.PREFERRED_SIZE)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 90, javax.swing.GroupLayout.PREFERRED_SIZE))))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(jTxtCompetence, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2)
                    .addComponent(jTxtIdBank, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jTxtNameBank, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel3)
                    .addComponent(JtxtContractNumber, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel5)
                    .addComponent(jTxtOutstandingBalance, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel6)
                        .addComponent(jTxtOutstandingBalanceNew, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel4)
                        .addComponent(jTxtInterest, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jButton1)))
                .addGap(0, 0, Short.MAX_VALUE))
        );

        jTable1.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null}
            },
            new String [] {
                "Valor"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Double.class
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }
        });
        jTable1.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                jTable1KeyReleased(evt);
            }
        });
        jScrollPane1.setViewportView(jTable1);

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 125, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 1, Short.MAX_VALUE))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 158, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 0, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jTxtIdBankFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jTxtIdBankFocusGained
        idAnterior = jTxtIdBank.getText();
    }//GEN-LAST:event_jTxtIdBankFocusGained

    private void jTxtIdBankFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jTxtIdBankFocusLost
        String idAtual = jTxtIdBank.getText();

        if (!idAtual.equals(idAnterior)) {
            jTxtNameBank.setText("");
            var_consulta = 1;
            incluiPesquisa();
        }
    }//GEN-LAST:event_jTxtIdBankFocusLost

    private void JtxtContractNumberFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_JtxtContractNumberFocusGained
        idAnterior = JtxtContractNumber.getText();
    }//GEN-LAST:event_JtxtContractNumberFocusGained

    private void JtxtContractNumberFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_JtxtContractNumberFocusLost
        if (!idAnterior.equals(JtxtContractNumber.getText())) {

            findContract();

        }
    }//GEN-LAST:event_JtxtContractNumberFocusLost

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        try {
            saveData();
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, e.getMessage());
        }
    }//GEN-LAST:event_jButton1ActionPerformed

    private void jTxtCompetenceKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jTxtCompetenceKeyPressed
        tools.AcaoPadrao.acaoPadraoTeclado(evt, jTxtCompetence, this);
    }//GEN-LAST:event_jTxtCompetenceKeyPressed

    private void jTxtIdBankKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jTxtIdBankKeyPressed
        tools.AcaoPadrao.acaoPadraoTeclado(evt, jTxtIdBank, this);
        // TODO add your handling code here:
    }//GEN-LAST:event_jTxtIdBankKeyPressed

    private void JtxtContractNumberKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_JtxtContractNumberKeyPressed
        tools.AcaoPadrao.acaoPadraoTeclado(evt, JtxtContractNumber, this);
        // TODO add your handling code here:
    }//GEN-LAST:event_JtxtContractNumberKeyPressed

    private void jTxtInterestKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jTxtInterestKeyPressed
        tools.AcaoPadrao.acaoPadraoTeclado(evt, jTxtInterest, this);
        // TODO add your handling code here:
    }//GEN-LAST:event_jTxtInterestKeyPressed

    private void jTxtInterestFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jTxtInterestFocusLost
        Double x = Double.parseDouble(jTxtInterest.getText().replace(".", "").replace(",", "."));

        System.out.println("idAnterior: " + idAnterior);

        if (!jTxtInterest.getText().equals(idAnterior) && !idAnterior.equals("0,00")) {

            int z = JOptionPane.showConfirmDialog(this, "Deseja somar este valor ao saldo anterior?", "Alteração de Juros", JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE);

            if (z == 0) {
                jTxtInterest.setText(tools.FormatNumbers.numUsToBr(x + oldInterest));
            }
        }

        sumOutstandingBalance();
    }//GEN-LAST:event_jTxtInterestFocusLost

    private void jTxtCompetenceFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jTxtCompetenceFocusGained
        idAnterior = jTxtCompetence.getText();
    }//GEN-LAST:event_jTxtCompetenceFocusGained

    private void jTxtCompetenceFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jTxtCompetenceFocusLost
        if (!idAnterior.equals(jTxtCompetence.getText())) {

            if (!"".equals(jTxtNameBank.getText())
                    && !"".equals(JtxtContractNumber.getText())) {
                findContract();
            }

        }
    }//GEN-LAST:event_jTxtCompetenceFocusLost

    private void jTxtInterestFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jTxtInterestFocusGained
        oldInterest = Double.parseDouble(jTxtInterest.getText().replace(".", "").replace(",", "."));
        idAnterior = jTxtInterest.getText();
    }//GEN-LAST:event_jTxtInterestFocusGained

    private void jTable1KeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jTable1KeyReleased
        int rows = 0;
        for (int i = 0; i < jTable1.getRowCount(); i++) {
            try {
                if ("".equals(jTable1.getValueAt(i, 0).toString())) {
                    rows++;
                }
            } catch (Exception e) {
            tools.DefaultMsg.errorMsg(e.getMessage());
            }
            if ((i + 1) == jTable1.getRowCount()) {
                    if(rows == 0){
                        
                    }
            }

        }
    }//GEN-LAST:event_jTable1KeyReleased


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTextField JtxtContractNumber;
    private javax.swing.JButton jButton1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTable jTable1;
    private javax.swing.JFormattedTextField jTxtCompetence;
    private javax.swing.JTextField jTxtIdBank;
    private javax.swing.JTextField jTxtInterest;
    private javax.swing.JTextField jTxtNameBank;
    private javax.swing.JTextField jTxtOutstandingBalance;
    private javax.swing.JTextField jTxtOutstandingBalanceNew;
    // End of variables declaration//GEN-END:variables

    private void incluiPesquisa() {

        switch (var_consulta) {
            case 1:

                String id = jTxtIdBank.getText();

                sql = "SELECT distinct a.fornecedor, a.banco, b.title as namebank "
                        + "FROM FECHAMENTO.fin_contratos a "
                        + "left join fechamento.cad_bancos b on (b.id = a.banco) "
                        + "where a.fornecedor = '" + id + "' "
                        + "order by b.title; ";

                if (cn.iniciarTransacao()) {
                    try {
                        cn.executeConsulta(sql);
                        while (cn.rs.next()) {
                            jTxtNameBank.setText(cn.rs.getString("namebank"));
                        }

                        if ("".equals(jTxtNameBank.getText())) {
                            jTxtIdBank.setText("");
                            jTxtIdBank.grabFocus();
                            throw new Exception("Não existe banco vinculado ao fornecedor " + id + ".\nTente importar os contratos de financiamentos para continuar.");
                        }

                    } catch (Exception e) {
                        JOptionPane.showMessageDialog(null, e.getMessage());
                    } finally {
                        cn.finalizarTransacao();
                    }
                }

                break;

            case 2:

                outstandingbalance = 0.00;

                if (cn.iniciarTransacao()) {
                    try {
                        sql = "select saldos.banco, saldos.numero, saldos.fornecedor, "
                                + "sum(saldos.saldo) as saldo, saldos.vencimento "
                                + "from ( "
                                + "select a.id, a.banco, a.numero, a.fornecedor, a.valor + "
                                + "coalesce((select sum(b.juros - b.amortizacao - b.descontos) "
                                + "     from fechamento.fin_contratos_movimentos b "
                                + "     where b.id = a.id and b.data <= '" + tools.FormatNumbers.dateUsDefault(tools.ManipulaData.lastDay(jTxtCompetence.getText())) + "'),0.00) as saldo,"
                                + "a.vencimento "
                                + "from fechamento.fin_contratos a "
                                + "where a.liberacao <= '" + tools.FormatNumbers.dateUsDefault(tools.ManipulaData.lastDay(jTxtCompetence.getText())) + "' "
                                + "and a.numero = '" + JtxtContractNumber.getText() + "') as saldos "
                                + "group by saldos.banco, saldos.numero, saldos.fornecedor "
                                + "having round(sum(saldos.saldo),2) != 0.00;";
                        cn.executeConsulta(sql);
                        while (cn.rs.next()) {
                            outstandingbalance = cn.rs.getDouble("saldo");
                            vencimento = cn.rs.getString("vencimento");
                        }

                        if (outstandingbalance == 0.00) {
                            JtxtContractNumber.grabFocus();
                            JtxtContractNumber.setText("");
                            throw new Exception("Contrato " + JtxtContractNumber.getText() + " não encontrado.\nVerifique o número digitado ou importe os contratos para continuar.");
                        }

                    } catch (Exception e) {
                        JOptionPane.showMessageDialog(this, e.getMessage());
                    } finally {
                        cn.finalizarTransacao();
                    }

                    jTxtOutstandingBalance.setText(tools.FormatNumbers.numUsToBr(outstandingbalance));

                }

                if (cn.iniciarTransacao()) {
                    try {
                        sql = "select juros from fechamento.fin_contratos_juros_padrao "
                                + "where numero = '" + JtxtContractNumber.getText() + "' "
                                + "and fornecedor = '" + jTxtIdBank.getText() + "' "
                                + "and competencia = '" + tools.FormatNumbers.dateUsDefault(tools.ManipulaData.lastDay(jTxtCompetence.getText())) + "'; ";
                        cn.executeConsulta(sql);
                        while (cn.rs.next()) {
                            jTxtInterest.setText(tools.FormatNumbers.numUsToBr(cn.rs.getDouble("juros")));
                        }
                    } catch (Exception e) {
                        JOptionPane.showMessageDialog(this, e.getMessage());
                    } finally {
                        cn.finalizarTransacao();
                    }
                }

                if ("0,00".equals(jTxtInterest.getText())) {
                    var_update = false;
                } else {
                    var_update = true;
                }

                break;
        }

    }

    private void saveData() throws Exception {
        if (var_update) {
            sql = "UPDATE fechamento.fin_contratos_juros_padrao "
                    + "SET juros = '" + jTxtInterest.getText().replace(".", "").replace(",", ".") + "' "
                    + "WHERE numero = '" + JtxtContractNumber.getText() + "' "
                    + "and fornecedor = '" + jTxtIdBank.getText() + "' "
                    + "and competencia = '" + tools.FormatNumbers.dateUsDefault(tools.ManipulaData.lastDay(jTxtCompetence.getText())) + "';";
        } else {
            sql = "INSERT INTO fechamento.fin_contratos_juros_padrao "
                    + "(numero, fornecedor, competencia, vencimento, juros) "
                    + "VALUES ('" + JtxtContractNumber.getText() + "',"
                    + "'" + jTxtIdBank.getText() + "','" + tools.FormatNumbers.dateUsDefault(tools.ManipulaData.lastDay(jTxtCompetence.getText())) + "',"
                    + "'" + vencimento + "',"
                    + "'" + jTxtInterest.getText().replace(".", "").replace(",", ".") + "');";
        }

        if (cn.iniciarTransacao()) {
            try {
                cn.executeAtualizacao(sql);
                clearFields();
                JtxtContractNumber.grabFocus();
            } catch (Exception e) {
                throw new Exception(e);
            } finally {
                cn.finalizarTransacao();
            }
        }
    }

    private void clearFields() {
        JtxtContractNumber.setText("");
        jTxtOutstandingBalance.setText("");
        jTxtOutstandingBalanceNew.setText("");
        jTxtInterest.setText("0,00");
    }

    private void sumOutstandingBalance() {
        Double x = Double.parseDouble(jTxtInterest.getText().replace(".", "").replace(",", "."));

        jTxtOutstandingBalanceNew.setText(tools.FormatNumbers.numUsToBr(x + outstandingbalance));

    }

    private void findContract() {
        jTxtOutstandingBalance.setText("");
        jTxtInterest.setText("");

        var_consulta = 2;
        incluiPesquisa();
    }
}
